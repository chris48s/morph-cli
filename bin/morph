#!/usr/bin/env ruby
# Commandline client for controlling morph and running scrapers and things

require "thor"
require "rest_client"
# TODO Do compression on the tar file
#require 'zlib'
require 'archive/tar/minitar'
require 'pathname'
require 'json'
require 'morph-cli'

class MorphThor < Thor
  class_option :dev, default: false, type: :boolean, desc: "Run against a local dev of Morph running at http://localhost:3000"

  desc "[execute]", "execute morph scraper"
  option :directory, :default => Dir.getwd

  def execute
    api_key = MorphCLI.retrieve_api_key    
    api_key = ask_and_save_api_key(options) if api_key.nil?

    api_key_is_valid = false
    until api_key_is_valid
      begin
        MorphCLI.execute(options[:directory], api_key, options[:dev])
        api_key_is_valid = true
      rescue RestClient::Unauthorized
        puts "Your key isn't working. Let's try again."
        api_key = ask_and_save_api_key(options)
      end
    end
  end

  no_commands {
    def ask_and_save_api_key(options)
      api_key = ask("What is your key? (Go to #{MorphCLI.base_url(options[:dev])}/settings)")
      MorphCLI.save_api_key(api_key)
      api_key
    end
  }
end

# If morph is run without any parameters it's the same as "morph execute"
MorphThor.start(ARGV.empty? ? ["execute"] : ARGV)
